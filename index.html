<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>House Flip Deal Analyzer</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com/"></script>
    <!-- Load React and ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Load Babel for compiling JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Custom style -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background-color: #f9fafb;
        }
    </style>
</head>
<body>
    <!-- This is where the React App will attach -->
    <div id="root"></div>

    <script type="text/babel">
        // --- Custom Hooks & Helpers ---

        // Helper to format currency
        const formatCurrency = (value) => {
          if (isNaN(value)) return '$0';
          return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0,
          }).format(value);
        };

        // Helper to format percentage
        const formatPercent = (value) => {
          if (isNaN(value) || value === Infinity) return '0.0%';
          return `${(value * 100).toFixed(1)}%`;
        }

        // Custom Input Component for main fields (Fix for focus loss)
        const CostInput = ({ label, value, field, type = 'number', unit = '', placeholder = 0, handler, extraContent }) => {
          const [localValue, setLocalValue] = React.useState(value);
          const [isFocused, setIsFocused] = React.useState(false);

          React.useEffect(() => {
            if (!isFocused) {
              setLocalValue(value);
            }
          }, [value, isFocused]);

          const handleLocalChange = (e) => {
            setLocalValue(e.target.value);
          };

          const handleBlur = () => {
            setIsFocused(false);
            let finalValue = localValue;
            if (type === 'number') {
              finalValue = parseFloat(localValue) || 0;
            }
            handler(field, finalValue);
            setLocalValue(finalValue);
          };
          
          const displayValue = isFocused ? localValue : (value === 0 && !isFocused ? '' : value);

          return (
            <div className="flex justify-between items-center py-2 border-b border-gray-100">
              <label htmlFor={field} className="text-gray-700 text-sm md:text-base">{label}</label>
              <div className="flex items-center space-x-2">
                {unit === '$' && <span className="text-gray-500 mr-1">$</span>}
                <input
                  id={field}
                  type="text"
                  inputMode="numeric"
                  min="0"
                  value={displayValue}
                  onFocus={() => setIsFocused(true)}
                  onChange={handleLocalChange}
                  onBlur={handleBlur}
                  placeholder={placeholder}
                  className="w-24 text-right py-1 px-2 border rounded-md focus:border-indigo-500 focus:ring-indigo-500 text-sm md:text-base"
                />
                {unit === '%' && <span className="text-gray-500 ml-1">%</span>}
                {unit === 'mo' && <span className="text-gray-500 ml-1 text-sm">months</span>}
                {extraContent}
              </div>
            </div>
          );
        };

        // --- Main App Component ---
        const Root = () => {
          // --- State for All Calculator Inputs ---
          
          // Step 1
          const [arv, setArv] = React.useState(0);
          
          // Step 2
          const [buyingCosts, setBuyingCosts] = React.useState({
            loanPointsPercent: 2.0,
            lendersTitleInsurance: 1000,
            appraisal: 600,
            inspection: 400,
            other: 500,
          });
          const [holdingCosts, setHoldingCosts] = React.useState({
            rehabPeriod: 4,
            listingPeriod: 2,
            piti: 0,
            utilities: 0,
            insurance: 0,
            hoa: 0,
            maintenance: 0,
            other: 0,
          });
          const [sellingCosts, setSellingCosts] = React.useState({
            brokerageFee: 6.0,
            ownersTitleInsurance: 1500,
            homeWarranty: 600,
            secondAppraisalBPO: 250,
            staging: 1000,
            other: 0,
          });
          const [financing, setFinancing] = React.useState({
            isCashBuy: true,
            loanAmount: 0,
            interestRate: 7.0,
          });

          // Step 3
          const [repairCosts, setRepairCosts] = React.useState({
            items: [],
            lumpSum: 0,
            useLumpSum: false,
            contingencyPercent: 10.0,
            locationMultiplierPercent: 0,
            permitCost: 0,
            contractorOHPercent: 0,
          });

          // Step 4
          const [targetProfitPercent, setTargetProfitPercent] = React.useState(15);
          
          // --- Handlers for Updating State ---
          const handleSimpleUpdate = (setter) => (field, value) => {
            setter(prev => ({ ...prev, [field]: value }));
          };
          
          const handleRepairUpdate = (id, field, value) => {
            setRepairCosts(prev => ({
              ...prev,
              items: prev.items.map(item =>
                item.id === id ? { ...item, [field]: value } : item
              ),
            }));
          };
          
          const addRepairItem = () => {
            setRepairCosts(prev => ({
              ...prev,
              items: [
                ...prev.items,
                { id: Date.now(), description: '', cost: 0 },
              ],
            }));
          };

          const removeRepairItem = (id) => {
            setRepairCosts(prev => ({
              ...prev,
              items: prev.items.filter(item => item.id !== id),
            }));
          };

          // --- Suggestion Handlers ---
          const suggestCosts = (type) => {
            if (type === 'lendersTitle') {
              setBuyingCosts(prev => ({ ...prev, lendersTitleInsurance: 1000 }));
            }
            if (type === 'appraisal') {
              setBuyingCosts(prev => ({ ...prev, appraisal: 600 }));
            }
            if (type === 'inspection') {
              setBuyingCosts(prev => ({ ...prev, inspection: 400 }));
            }
            if (type === 'ownersTitle') {
              // CO Avg ~0.5-1.0% of ARV
              const suggested = Math.max(1500, (arv * 0.007)); // Use $1500 or 0.7%
              setSellingCosts(prev => ({ ...prev, ownersTitleInsurance: Math.round(suggested) }));
            }
            if (type === 'homeWarranty') {
              setSellingCosts(prev => ({ ...prev, homeWarranty: 600 }));
            }
            if (type === 'appraisalBPO') {
              setSellingCosts(prev => ({ ...prev, secondAppraisalBPO: 250 }));
            }
            if (type === 'staging') {
              setSellingCosts(prev => ({ ...prev, staging: 1000 }));
            }
          };
          

          // --- CORE CALCULATION LOGIC ---
          const calculations = React.useMemo(() => {
            const totalHoldingMonths = (parseFloat(holdingCosts.rehabPeriod) || 0) + (parseFloat(holdingCosts.listingPeriod) || 0);

            // 1. Calculate Total Fixed Costs
            const totalBuyingCosts = (financing.isCashBuy ? 0 : (financing.loanAmount * (buyingCosts.loanPointsPercent / 100))) +
                                     buyingCosts.lendersTitleInsurance +
                                     buyingCosts.appraisal +
                                     buyingCosts.inspection +
                                     buyingCosts.other;
                                     
            const totalMonthlyHolding = holdingCosts.piti + holdingCosts.utilities + holdingCosts.insurance + holdingCosts.hoa + holdingCosts.maintenance + holdingCosts.other;
            const totalHoldingCosts = totalMonthlyHolding * totalHoldingMonths;
            
            const totalSellingCosts = (arv * (sellingCosts.brokerageFee / 100)) +
                                      sellingCosts.ownersTitleInsurance +
                                      sellingCosts.homeWarranty +
                                      sellingCosts.secondAppraisalBPO +
                                      sellingCosts.staging +
                                      sellingCosts.other;

            const totalFinancingCosts = financing.isCashBuy ? 0 : (financing.loanAmount * (financing.interestRate / 100 / 12) * totalHoldingMonths);
            
            const totalFixedCosts = totalBuyingCosts + totalHoldingCosts + totalSellingCosts + totalFinancingCosts;
            
            // 2. Calculate Total Repair Costs (TRC)
            const baseRepairCost = repairCosts.useLumpSum ? repairCosts.lumpSum : repairCosts.items.reduce((sum, item) => sum + item.cost, 0);
            const withContingency = baseRepairCost * (1 + (repairCosts.contingencyPercent / 100));
            const withLocation = withContingency * (1 + (repairCosts.locationMultiplierPercent / 100));
            const withContractor = withLocation * (1 + (repairCosts.contractorOHPercent / 100));
            const finalTRC = withContractor + repairCosts.permitCost;
            
            // 3. Calculate Profit & MAO
            const targetProfit = arv * (targetProfitPercent / 100);
            
            // This is the core number: MAO = ARV - All Costs - Target Profit
            const maxPurchasePrice = arv - totalFixedCosts - finalTRC - targetProfit;
            
            // 4. Calculate 70% Rule for comparison
            const mao70Rule = (arv * 0.70) - finalTRC;
            
            // 5. Calculate Final Metrics based on calculated MAO
            const totalProjectCosts = maxPurchasePrice + totalBuyingCosts + finalTRC + totalHoldingCosts + totalFinancingCosts;
            
            const debt = financing.isCashBuy ? 0 : financing.loanAmount;
            
            // Capital Needed = (Purchase Price - Loan) + Buying Costs + Financing Costs
            const capitalNeeded = (maxPurchasePrice - debt) + totalBuyingCosts + (financing.isCashBuy ? 0 : (financing.loanAmount * (buyingCosts.loanPointsPercent / 100)));
            
            // Total Cash Invested = Capital Needed + Holding Costs + Repair Costs (assuming not financed)
            const totalCashInvested = capitalNeeded + totalHoldingCosts + finalTRC;
            
            const profitPerMonth = (totalHoldingMonths > 0) ? (targetProfit / totalHoldingMonths) : 0;
            const cashROI = (totalCashInvested > 0) ? (targetProfit / totalCashInvested) : 0;
            const annualizedROI = (totalHoldingMonths > 0) ? (cashROI * (12 / totalHoldingMonths)) : 0;
            
            return {
              totalFixedCosts,
              totalBuyingCosts,
              totalHoldingCosts,
              totalSellingCosts,
              totalFinancingCosts,
              finalTRC,
              targetProfit,
              maxPurchasePrice,
              mao70Rule,
              totalProjectCosts,
              capitalNeeded,
              debt,
              totalCashInvested,
              profitPerMonth,
              cashROI,
              annualizedROI,
              totalMonthlyHolding,
              totalHoldingMonths,
            };
            
          }, [arv, buyingCosts, holdingCosts, sellingCosts, financing, repairCosts, targetProfitPercent]);
          
          
          // --- UI Components for each step ---
          
          const Step1_ARV = () => (
            <div>
              <h2 className="text-2xl font-bold text-indigo-700 mb-4">Step 1: After Repair Value (ARV)</h2>
              <div className="bg-white p-5 rounded-xl shadow-md border border-indigo-100">
                <CostInput
                  label="After Repair Value (ARV)"
                  value={arv}
                  field="arv"
                  unit="$"
                  handler={(field, value) => setArv(value)}
                />
              </div>
            </div>
          );
          
          const Step2_FixedCosts = () => (
            <div>
              <h2 className="text-2xl font-bold text-indigo-700 mb-4">Step 2: Fixed Costs</h2>
              <div className="space-y-6">
              
                {/* Buying Costs */}
                <div className="bg-white p-5 rounded-xl shadow-md border border-indigo-100">
                  <h3 className="text-xl font-semibold mb-2 text-indigo-600">Buying Costs</h3>
                  <CostInput label="Loan Points" value={buyingCosts.loanPointsPercent} field="loanPointsPercent" unit="%" handler={handleSimpleUpdate(setBuyingCosts)} />
                  <p className="text-xs text-gray-500 pl-4 -mt-2 mb-2">Origination fees paid to the lender, typically 1-2% of the loan amount.</p>
                  
                  <CostInput 
                    label="Lender's Title Insurance" 
                    value={buyingCosts.lendersTitleInsurance} 
                    field="lendersTitleInsurance" 
                    unit="$" 
                    handler={handleSimpleUpdate(setBuyingCosts)}
                    extraContent={
                      <button onClick={() => suggestCosts('lendersTitle')} className="text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded-full hover:bg-gray-200 transition">
                        Suggest
                      </button>
                    }
                  />
                  <p className="text-xs text-gray-500 pl-4 -mt-2 mb-2">Required by the lender. Avg. in CO is ~$1,000.</p>
                  
                  <CostInput 
                    label="Appraisal" 
                    value={buyingCosts.appraisal} 
                    field="appraisal" 
                    unit="$" 
                    handler={handleSimpleUpdate(setBuyingCosts)}
                    extraContent={
                      <button onClick={() => suggestCosts('appraisal')} className="text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded-full hover:bg-gray-200 transition">
                        Suggest
                      </button>
                    }
                  />
                  <p className="text-xs text-gray-500 pl-4 -mt-2 mb-2">Lender-required valuation of the property. Avg. in CO is ~$600.</p>
                  
                  <CostInput 
                    label="Inspection" 
                    value={buyingCosts.inspection} 
                    field="inspection" 
                    unit="$" 
                    handler={handleSimpleUpdate(setBuyingCosts)}
                    extraContent={
                      <button onClick={() => suggestCosts('inspection')} className="text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded-full hover:bg-gray-200 transition">
                        Suggest
                      </button>
                    }
                  />
                  <p className="text-xs text-gray-500 pl-4 -mt-2 mb-2">Cost for a general home inspector. Avg. in CO is ~$400.</p>

                  <CostInput label="Other Buying Costs" value={buyingCosts.other} field="other" unit="$" handler={handleSimpleUpdate(setBuyingCosts)} />
                  <p className="text-xs text-gray-500 pl-4 -mt-2 mb-2">Property survey, recording fees, attorney fees, etc. (Can be 0.5-1% of price).</p>
                  
                  <div className="p-3 bg-indigo-50 rounded-lg shadow-inner mt-4">
                    <div className="flex justify-between items-center font-bold text-base text-indigo-800">
                      <span>Total Buying Costs:</span>
                      <span>{formatCurrency(calculations.totalBuyingCosts)}</span>
                    </div>
                  </div>
                </div>
                
                {/* Holding Costs */}
                <div className="bg-white p-5 rounded-xl shadow-md border border-indigo-100">
                  <h3 className="text-xl font-semibold mb-2 text-indigo-600">Holding Costs</h3>
                  <CostInput label="Rehab Period" value={holdingCosts.rehabPeriod} field="rehabPeriod" unit="mo" handler={handleSimpleUpdate(setHoldingCosts)} />
                  <p className="text-xs text-gray-500 pl-4 -mt-2 mb-2">Estimated time (in months) to complete the renovation.</p>
                  
                  <CostInput label="Listing Period" value={holdingCosts.listingPeriod} field="listingPeriod" unit="mo" handler={handleSimpleUpdate(setHoldingCosts)} />
                  <p className="text-xs text-gray-500 pl-4 -mt-2 mb-2">Estimated time (in months) from listing to final sale closing.</p>
                  
                  <div className="mt-4 pt-4 border-t">
                    <h4 className="text-sm font-semibold text-gray-700 mb-2">Itemized Monthly Holding Costs ({formatCurrency(calculations.totalMonthlyHolding)}/mo):</h4>
                    <CostInput label="&nbsp;&nbsp;&nbsp;PITI (or Debt Service)" value={holdingCosts.piti} field="piti" unit="$" handler={handleSimpleUpdate(setHoldingCosts)} />
                    <p className="text-xs text-gray-500 pl-8 -mt-2 mb-2">Principal, Interest, Taxes, and Insurance.</p>
                    <CostInput label="&nbsp;&nbsp;&nbsp;Utilities" value={holdingCosts.utilities} field="utilities" unit="$" handler={handleSimpleUpdate(setHoldingCosts)} />
                    <p className="text-xs text-gray-500 pl-8 -mt-2 mb-2">Water, electric, gas, trash, etc.</p>
                    <CostInput label="&nbsp;&nbsp;&nbsp;Insurance (Property)" value={holdingCosts.insurance} field="insurance" unit="$" handler={handleSimpleUpdate(setHoldingCosts)} />
                    <p className="text-xs text-gray-500 pl-8 -mt-2 mb-2">Vacancy or Builder's Risk policy (if not in PITI).</p>
                    <CostInput label="&nbsp;&nbsp;&nbsp;HOA Dues" value={holdingCosts.hoa} field="hoa" unit="$" handler={handleSimpleUpdate(setHoldingCosts)} />
                    <p className="text-xs text-gray-500 pl-8 -mt-2 mb-2">Homeowners' Association fees, if applicable.</p>
                    <CostInput label="&nbsp;&nbsp;&nbsp;Maintenance" value={holdingCosts.maintenance} field="maintenance" unit="$" handler={handleSimpleUpdate(setHoldingCosts)} />
                    <p className="text-xs text-gray-500 pl-8 -mt-2 mb-2">Lawn care, snow removal, etc.</p>
                    <CostInput label="&nbsp;&nbsp;&nbsp;Other Monthly Costs" value={holdingCosts.other} field="other" unit="$" handler={handleSimpleUpdate(setHoldingCosts)} />
                  </div>
                  
                  <div className="p-3 bg-indigo-50 rounded-lg shadow-inner mt-4">
                    <div className="flex justify-between items-center font-bold text-base text-indigo-800">
                      <span>Total Holding Costs ({calculations.totalHoldingMonths} mos):</span>
                      <span>{formatCurrency(calculations.totalHoldingCosts)}</span>
                    </div>
                  </div>
                </div>
                
                {/* Selling Costs */}
                <div className="bg-white p-5 rounded-xl shadow-md border border-indigo-100">
                  <h3 className="text-xl font-semibold mb-2 text-indigo-600">Selling Costs</h3>
                  <CostInput label="Brokerage Fee" value={sellingCosts.brokerageFee} field="brokerageFee" unit="%" handler={handleSimpleUpdate(setSellingCosts)} />
                  <p className="text-xs text-gray-500 pl-4 -mt-2 mb-2">Total commission for both buyer's and seller's agents. Avg. in CO is 5-6%.</p>

                  <CostInput 
                    label="Owner's Title Insurance" 
                    value={sellingCosts.ownersTitleInsurance} 
                    field="ownersTitleInsurance" 
                    unit="$" 
                    handler={handleSimpleUpdate(setSellingCosts)}
                    extraContent={
                      <button onClick={() => suggestCosts('ownersTitle')} className="text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded-full hover:bg-gray-200 transition">
                        Suggest
                      </button>
                    }
                  />
                  <p className="text-xs text-gray-500 pl-4 -mt-2 mb-2">Seller typically pays. Avg. in CO is 0.5-1.0% of ARV.</p>
                  
                  <CostInput 
                    label="Home Warranty" 
                    value={sellingCosts.homeWarranty} 
                    field="homeWarranty" 
                    unit="$" 
                    handler={handleSimpleUpdate(setSellingCosts)}
                    extraContent={
                      <button onClick={() => suggestCosts('homeWarranty')} className="text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded-full hover:bg-gray-200 transition">
                        Suggest
                      </button>
                    }
                  />
                  <p className="text-xs text-gray-500 pl-4 -mt-2 mb-2">Often offered to the buyer. Avg. in CO is ~$600.</p>
                  
                  <CostInput 
                    label="2nd Appraisal / BPO" 
                    value={sellingCosts.secondAppraisalBPO} 
                    field="secondAppraisalBPO" 
                    unit="$" 
                    handler={handleSimpleUpdate(setSellingCosts)}
                    extraContent={
                      <button onClick={() => suggestCosts('appraisalBPO')} className="text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded-full hover:bg-gray-200 transition">
                        Suggest
                      </button>
                    }
                  />
                  <p className="text-xs text-gray-500 pl-4 -mt-2 mb-2">Cost to verify ARV for your lender or partners. Avg. ~$250.</p>
                  
                  <CostInput 
                    label="Staging" 
                    value={sellingCosts.staging} 
                    field="staging" 
                    unit="$" 
                    handler={handleSimpleUpdate(setSellingCosts)}
                    extraContent={
                      <button onClick={() => suggestCosts('staging')} className="text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded-full hover:bg-gray-200 transition">
                        Suggest
                      </button>
                    }
                  />
                  <p className="text-xs text-gray-500 pl-4 -mt-2 mb-2">Cost to professionally stage the home for listing. Avg. ~$1000+.</p>

                  <CostInput label="Other Selling Costs" value={sellingCosts.other} field="other" unit="$" handler={handleSimpleUpdate(setSellingCosts)} />
                  <p className="text-xs text-gray-500 pl-4 -mt-2 mb-2">Seller concessions, repair credits, etc.</p>
                  
                  <div className="p-3 bg-indigo-50 rounded-lg shadow-inner mt-4">
                    <div className="flex justify-between items-center font-bold text-base text-indigo-800">
                      <span>Total Selling Costs:</span>
                      <span>{formatCurrency(calculations.totalSellingCosts)}</span>
                    </div>
                  </div>
                </div>
                
                {/* Financing Costs */}
                <div className="bg-white p-5 rounded-xl shadow-md border border-indigo-100">
                  <h3 className="text-xl font-semibold mb-2 text-indigo-600">Financing</h3>
                  <div className="flex items-center space-x-4 p-4">
                    <button
                      onClick={() => handleSimpleUpdate(setFinancing)('isCashBuy', true)}
                      className={`px-4 py-2 rounded-full font-semibold transition ${financing.isCashBuy ? 'bg-indigo-600 text-white shadow-md' : 'bg-white text-indigo-600 border border-indigo-300'}`}
                    >
                      All Cash
                    </button>
                    <button
                      onClick={() => handleSimpleUpdate(setFinancing)('isCashBuy', false)}
                      className={`px-4 py-2 rounded-full font-semibold transition ${!financing.isCashBuy ? 'bg-indigo-600 text-white shadow-md' : 'bg-white text-indigo-600 border border-indigo-300'}`}
                    >
                      Financing
                    </button>
                  </div>
                  {!financing.isCashBuy && (
                    <div className="pt-4 border-t">
                      <CostInput label="Loan Amount" value={financing.loanAmount} field="loanAmount" unit="$" handler={handleSimpleUpdate(setFinancing)} />
                      <p className="text-xs text-gray-500 pl-4 -mt-2 mb-2">Total amount borrowed for the project.</p>
                      <CostInput label="Interest Rate" value={financing.interestRate} field="interestRate" unit="%" handler={handleSimpleUpdate(setFinancing)} />
                      <p className="text-xs text-gray-500 pl-4 -mt-2 mb-2">Annual interest rate on the loan.</p>
                    </div>
                  )}
                  <div className="p-3 bg-indigo-50 rounded-lg shadow-inner mt-4">
                    <div className="flex justify-between items-center font-bold text-base text-indigo-800">
                      <span>Total Financing Costs (Interest):</span>
                      <span>{formatCurrency(calculations.totalFinancingCosts)}</span>
                    </div>
                  </div>
                </div>
                
                {/* Total Fixed Costs */}
                <div className="p-4 bg-indigo-50 rounded-lg shadow-inner mt-4">
                  <div className="flex justify-between items-center font-bold text-xl text-indigo-800">
                    <span>Total Fixed Costs:</span>
                    <span>{formatCurrency(calculations.totalFixedCosts)}</span>
                  </div>
                </div>
                
              </div>
            </div>
          );
          
          const Step3_RepairCosts = () => (
            <div>
              <h2 className="text-2xl font-bold text-indigo-700 mb-4">Step 3: Repair Costs (TRC)</h2>
              <div className="space-y-6">

                {/* Mode Switch */}
                <div className="flex items-center space-x-4 p-4 bg-yellow-50 rounded-xl shadow-md border border-yellow-200">
                  <span className="font-semibold text-yellow-800">Input Mode:</span>
                  <button
                    onClick={() => handleSimpleUpdate(setRepairCosts)('useLumpSum', false)}
                    className={`px-4 py-2 rounded-full font-semibold transition ${!repairCosts.useLumpSum ? 'bg-indigo-600 text-white shadow-md' : 'bg-white text-indigo-600 border border-indigo-300'}`}
                  >
                    Itemized Costs
                  </button>
                  <button
                    onClick={() => handleSimpleUpdate(setRepairCosts)('useLumpSum', true)}
                    className={`px-4 py-2 rounded-full font-semibold transition ${repairCosts.useLumpSum ? 'bg-indigo-600 text-white shadow-md' : 'bg-white text-indigo-600 border border-indigo-300'}`}
                  >
                    Lump Sum
                  </button>
                </div>

                {/* Lump Sum or Itemized */}
                {repairCosts.useLumpSum ? (
                  <div className="bg-white p-5 rounded-xl shadow-md border border-indigo-100">
                    <CostInput label="Lump Sum Repair Cost" value={repairCosts.lumpSum} field="lumpSum" unit="$" handler={handleSimpleUpdate(setRepairCosts)} />
                  </div>
                ) : (
                  <div className="bg-white p-5 rounded-xl shadow-md border border-indigo-100">
                    <h3 className="text-xl font-semibold mb-4 text-indigo-600">Itemized Rehab Breakdown</h3>
                    <div className="grid grid-cols-12 gap-2 font-semibold text-sm text-gray-600 border-b pb-2 mb-2">
                      <div className="col-span-8">Description</div>
                      <div className="col-span-3 text-right">Cost ($)</div>
                      <div className="col-span-1"></div>
                    </div>
                    {repairCosts.items.map((item) => (
                      <div key={item.id} className="grid grid-cols-12 gap-2 items-center py-2 border-b border-gray-100">
                        <input
                          type="text"
                          value={item.description}
                          onChange={(e) => handleRepairUpdate(item.id, 'description', e.target.value)}
                          className="col-span-8 p-1 border rounded-md text-sm"
                          placeholder="e.g., Kitchen Cabinets"
                        />
                        <input
                          type="number"
                          value={item.cost === 0 ? '' : item.cost}
                          onChange={(e) => handleRepairUpdate(item.id, 'cost', parseFloat(e.target.value) || 0)}
                          className="col-span-3 p-1 border rounded-md text-right text-sm"
                          placeholder="0"
                        />
                        <button
                          onClick={() => removeRepairItem(item.id)}
                          className="col-span-1 text-red-500 hover:text-red-700 transition"
                          title="Remove Item"
                        >
                          &times;
                        </button>
                      </div>
                    ))}
                    <button
                      onClick={addRepairItem}
                      className="mt-4 px-4 py-2 text-sm bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 transition"
                    >
                      + Add Repair Item
                    </button>
                  </div>
                )}
                
                {/* Cost Modifiers */}
                <div className="bg-white p-5 rounded-xl shadow-md border border-indigo-100">
                  <h3 className="text-xl font-semibold mb-2 text-indigo-600">Repair Cost Modifiers</h3>
                  <CostInput label="Contingency" value={repairCosts.contingencyPercent} field="contingencyPercent" unit="%" handler={handleSimpleUpdate(setRepairCosts)} />
                  <p className="text-xs text-gray-500 pl-4 -mt-2 mb-2">A "buffer" for unexpected repairs. 10-20% is common.</p>
                  
                  <CostInput label="Contractor OH&P" value={repairCosts.contractorOHPercent} field="contractorOHPercent" unit="%" handler={handleSimpleUpdate(setRepairCosts)} />
                  <p className="text-xs text-gray-500 pl-4 -mt-2 mb-2">Overhead & Profit for a General Contractor, if used. 10-20% is common.</p>

                  <CostInput label="Location Multiplier" value={repairCosts.locationMultiplierPercent} field="locationMultiplierPercent" unit="%" handler={handleSimpleUpdate(setRepairCosts)} />
                  <p className="text-xs text-gray-500 pl-4 -mt-2 mb-2">Adjust for high-cost-of-living (HCOL) areas. e.g., 5% for Boulder.</p>

                  <CostInput label="Permit Costs (Fixed)" value={repairCosts.permitCost} field="permitCost" unit="$" handler={handleSimpleUpdate(setRepairCosts)} />
                  <p className="text-xs text-gray-500 pl-4 -mt-2 mb-2">Fixed cost for city/county permits, separate from other items.</p>
                </div>
                
                {/* Total Repair Costs */}
                <div className="p-4 bg-green-50 rounded-lg shadow-inner mt-4">
                  <div className="flex justify-between items-center font-bold text-xl text-green-800">
                    <span>Total Repair Costs (TRC):</span>
                    <span>{formatCurrency(calculations.finalTRC)}</span>
                  </div>
                </div>
                
              </div>
            </div>
          );
          
          const Step4_Summary = () => (
            <div>
              <h2 className="text-2xl font-bold text-indigo-700 mb-4">Step 4: Profit & Summary</h2>
              <div className="space-y-6">

                {/* Profit Selection */}
                <div className="bg-white p-5 rounded-xl shadow-md border border-indigo-100">
                  <h3 className="text-xl font-semibold mb-4 text-indigo-600">Select Target Profit</h3>
                  <div className="flex flex-wrap gap-2">
                    {[5, 10, 15, 20, 25, 30].map(percent => (
                      <button
                        key={percent}
                        onClick={() => setTargetProfitPercent(percent)}
                        className={`px-4 py-2 rounded-full font-semibold transition ${targetProfitPercent === percent ? 'bg-indigo-600 text-white shadow-md' : 'bg-white text-indigo-600 border border-indigo-300'}`}
                      >
                        {percent}% of ARV
                      </button>
                    ))}
                  </div>
                  <div className="mt-4 pt-4 border-t text-center">
                    <span className="text-gray-700 text-lg">Target Profit: </span>
                    <span className="font-bold text-2xl text-green-700">{formatCurrency(calculations.targetProfit)}</span>
                  </div>
                </div>

                {/* MAO & 70% Rule */}
                <div className="bg-orange-600 text-white p-6 rounded-xl shadow-2xl border-4 border-orange-400 text-center">
                  <div className="text-xl font-semibold mb-2">Maximum Purchase Price (MAO)</div>
                  <div className="text-5xl font-extrabold mb-4">{formatCurrency(calculations.maxPurchasePrice)}</div>
                  <p className="text-orange-100">This is the most you can pay to hit your {targetProfitPercent}% profit target.</p>
                  
                  <div className="mt-4 pt-4 border-t border-orange-400">
                    <div className="text-lg font-semibold">70% Rule MAO (for comparison):</div>
                    <div className="text-2xl font-bold text-orange-200">{formatCurrency(calculations.mao70Rule)}</div>
                  </div>
                </div>
                
                {/* Key Metrics */}
                <div className="bg-white p-5 rounded-xl shadow-md border border-gray-100">
                  <h3 className="text-xl font-semibold mb-4 text-gray-700">Key Metrics (at MAO)</h3>
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                    <div className="p-3 bg-gray-50 rounded-lg">
                      <div className="text-sm text-gray-500">Profit per Month</div>
                      <div className="text-xl font-bold text-indigo-700">{formatCurrency(calculations.profitPerMonth)}</div>
                    </div>
                    <div className="p-3 bg-gray-50 rounded-lg">
                      <div className="text-sm text-gray-500">Cash ROI</div>
                      <div className="text-xl font-bold text-indigo-700">{formatPercent(calculations.cashROI)}</div>
                    </div>
                    <div className="p-3 bg-gray-50 rounded-lg">
                      <div className="text-sm text-gray-500">Annualized ROI</div>
                      <div className="text-xl font-bold text-indigo-700">{formatPercent(calculations.annualizedROI)}</div>
                    </div>
                    <div className="p-3 bg-gray-50 rounded-lg">
                      <div className="text-sm text-gray-500">Total Profit</div>
                      <div className="text-xl font-bold text-green-700">{formatCurrency(calculations.targetProfit)}</div>
                    </div>
                  </div>
                </div>

                {/* Investment Breakdown */}
                <div className="bg-white p-5 rounded-xl shadow-md border border-gray-100">
                  <h3 className="text-xl font-semibold mb-4 text-gray-700">Investment Breakdown (at MAO)</h3>
                  <div className="space-y-2">
                    <div className="flex justify-between text-base">
                      <span className="text-gray-600">Capital Needed (Cash to Close)</span>
                      <span className="font-medium text-indigo-600">{formatCurrency(calculations.capitalNeeded)}</span>
                    </div>
                    <div className="flex justify-between text-base">
                      <span className="text-gray-600">Total Cash Invested (Capital + Holding + Repairs)</span>
                      <span className="font-medium text-indigo-600">{formatCurrency(calculations.totalCashInvested)}</span>
                    </div>
                     <div className="flex justify-between text-base">
                      <span className="text-gray-600">Debt (Loan Amount)</span>
                      <span className="font-medium text-gray-600">{formatCurrency(calculations.debt)}</span>
                    </div>
                    <div className="flex justify-between font-bold text-lg border-t pt-2 mt-2">
                      <span>Total Project Costs</span>
                      <span className="text-red-700">{formatCurrency(calculations.totalProjectCosts)}</span>
                    </div>
                  </div>
                </div>
                
              </div>
            </div>
          );

          return (
            <div className="min-h-screen bg-gray-50 p-4 sm:p-8">
              <h1 className="text-4xl font-extrabold text-indigo-800 mb-6 text-center">
                House Flip Deal Analyzer 
              </h1>
              
              <div className="max-w-4xl mx-auto space-y-12">
                {/* Render All Steps Sequentially */}
                <div className="mt-8 space-y-12">
                  <Step1_ARV />
                  <Step2_FixedCosts />
                  <Step3_RepairCosts />
                  <Step4_Summary />
                </div>
              </div>
            </div>
          );
        };
        
        // ** FIX for Console Warning **
        // Using the modern React 18 createRoot API.
        // This resolves the console warning, but can be unstable in some preview environments.
        const container = document.getElementById('root');
        if (container) {
          const root = ReactDOM.createRoot(container);
          root.render(<Root />);
        } else {
          console.error("Root element not found. The app could not be started.");
        }
    </script>
</body>
</html>
