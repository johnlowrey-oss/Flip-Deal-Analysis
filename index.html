<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>House Flip Deal Analyzer</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com/"></script>
    <!-- Load React and ReactDOM (These are necessary for React to run) -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Load Babel for compiling JSX (This lets the browser read the JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Load Firebase SDK Scripts -->
    <!-- Note: You will need to replace the config object below with your actual details to enable saving/loading -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <!-- Custom style to ensure body and React app use the full screen -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background-color: #f9fafb; /* Matches the React app's background */
        }
    </style>
</head>
<body>
    <!-- This is where the React App will attach -->
    <div id="root"></div>

    <script type="text/babel">
        // Helper to format currency
        const formatCurrency = (value) => {
          return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0,
          }).format(value);
        };

        // Helper to format percentage
        const formatPercent = (value) => `${(value * 100).toFixed(1)}%`;

        // Initial data structure for a new deal (All fields zeroed out for clean start)
        const initialDealData = {
          // Deal Metadata
          dealName: 'New Flip Analysis',
          calculatedBy: '',

          // Section 1: Revenue & Targets
          currentOfferPrice: 0, 
          arv: 0,
          targetROI: 15.0, // Target ROI on Total Project Cost (as percent, e.g., 15.0 for 15%)
          
          // Section 2: Rehab Costs (Itemized/Lump Sum)
          rehabCosts: [], // Start with empty list
          rehabLumpSum: 0, 
          useLumpSum: false,

          // Section 3: Operating & Fixed Costs
          holdingPeriodMonths: 0,
          agentCommissionRate: 6.0, 
          buyerClosingFees: 0, 
          sellerClosingFees: 0, 
          fixedContingency: 0, 
          
          // Monthly Holding Cost Sub-fields
          monthlyPITI: 0,
          monthlyUtilities: 0,
          monthlyOtherHolding: 0,

          // Section 4: Profit Splitting
          partners: [], // Start with empty list
        };

        // --- Firebase Globals (Live Keys) ---
        // *** IMPORTANT: Paste your Firebase config object here to enable saving/loading ***
        // 1. Go to Firebase Console, create a project.
        // 2. Create a Web App and copy the config object.
        // 3. Enable Firestore (Test Mode) and Anonymous Authentication.
        const firebaseConfig = {
            apiKey: "PASTE_YOUR_API_KEY_HERE",
            authDomain: "PASTE_YOUR_AUTH_DOMAIN_HERE",
            projectId: "PASTE_YOUR_PROJECT_ID_HERE",
            storageBucket: "PASTE_YOUR_STORAGE_BUCKET_HERE",
            messagingSenderId: "PASTE_YOUR_SENDER_ID_HERE",
            appId: "PASTE_YOUR_APP_ID_HERE"
        };
        // This variable is necessary for the auth logic to run correctly.
        const initialAuthToken = undefined;
        // -----------------------------------------------------------------------


        // --- Custom Input Component for main fields (Fix for focus loss) ---
        const CostInput = ({ label, value, field, type = 'number', unit = '', placeholder = 0, handler, extraContent }) => {
          const [localValue, setLocalValue] = React.useState(value);
          const [isFocused, setIsFocused] = React.useState(false);

          // Sync local state when parent value changes IF not focused
          React.useEffect(() => {
            if (!isFocused) {
              setLocalValue(value);
            }
          }, [value, isFocused]);

          const handleLocalChange = (e) => {
            // Allows user to type empty string, '.', etc., without state validation snapping back
            setLocalValue(e.target.value);
          };

          const handleBlur = () => {
            setIsFocused(false);
            
            let finalValue = localValue;
            if (type === 'number') {
              // Coerce to number only on blur, defaulting to 0 if invalid
              finalValue = parseFloat(localValue) || 0;
            }
            
            // Update parent state with the finalized numeric value
            handler(0, field, finalValue);
            
            // Resync local state to the clean numeric format
            setLocalValue(finalValue);
          };
          
          // For initial display if value is 0, show placeholder instead of 0
          const displayValue = isFocused ? localValue : (value === 0 && !isFocused ? '' : value);


          return (
            <div className="flex justify-between items-center py-2 border-b border-gray-100">
              <label htmlFor={field} className="text-gray-700 text-sm md:text-base">{label}</label>
              <div className="flex items-center space-x-2">
                {unit === '$' && <span className="text-gray-500 mr-1">$</span>}
                <input
                  id={field}
                  type="text" // Use text input type for better control over user input
                  inputMode="numeric" // Hint for mobile keyboards
                  min="0"
                  value={displayValue}
                  onFocus={() => setIsFocused(true)}
                  onChange={handleLocalChange}
                  onBlur={handleBlur}
                  placeholder={placeholder}
                  className="w-24 text-right py-1 px-2 border rounded-md focus:border-indigo-500 focus:ring-indigo-500 text-sm md:text-base"
                />
                {unit === '%' && <span className="text-gray-500 ml-1">%</span>}
                {unit === 'mo' && <span className="text-gray-500 ml-1 text-sm">months</span>}
                {extraContent}
              </div>
            </div>
          );
        };

        // --- Custom Input for Deal Metadata ---
        const MetadataInput = ({ label, value, field, handler, type = 'text' }) => {
            const [localValue, setLocalValue] = React.useState(value);
            const [isFocused, setIsFocused] = React.useState(false);

            React.useEffect(() => {
                if (!isFocused) {
                    setLocalValue(value);
                }
            }, [value, isFocused]);

            const handleLocalChange = (e) => setLocalValue(e.target.value);

            const handleBlur = () => {
                setIsFocused(false);
                handler(0, field, localValue);
            };

            return (
                <div className="flex flex-col">
                    <label htmlFor={field} className="text-xs font-medium text-gray-500">{label}</label>
                    <input
                        id={field}
                        type={type}
                        value={localValue}
                        onFocus={() => setIsFocused(true)}
                        onChange={handleLocalChange}
                        onBlur={handleBlur}
                        className="w-full text-base py-1 px-2 border-b border-gray-300 focus:border-indigo-500"
                    />
                </div>
            );
        };


        // --- Dedicated component for Itemized Rehab Costs (Fix for focus loss) ---
        const RehabItemCostInput = ({ id, cost, updateHandler }) => {
          const [localValue, setLocalValue] = React.useState(cost);
          const [isFocused, setIsFocused] = React.useState(false);

          // Sync local state when parent cost changes IF not focused
          React.useEffect(() => {
            if (!isFocused) {
              setLocalValue(cost);
            }
          }, [cost, isFocused]);

          const handleLocalChange = (e) => {
            setLocalValue(e.target.value);
          };

          const handleBlur = (e) => {
            setIsFocused(false);
            
            // Coerce to number only on blur, defaulting to 0 if invalid
            const finalValue = parseFloat(e.target.value) || 0;
            
            // Update parent state with the finalized numeric value
            updateHandler(id, 'cost', finalValue);
            
            // Resync local state to the clean numeric format
            setLocalValue(finalValue);
          };
          
          const displayValue = isFocused ? localValue : (cost === 0 && !isFocused ? '' : cost);


          return (
            <input
              type="text" // Use text input type to allow free typing
              inputMode="numeric"
              min="0"
              value={displayValue}
              onFocus={() => setIsFocused(true)}
              onChange={handleLocalChange}
              onBlur={handleBlur}
              className="col-span-3 p-1 border rounded-md text-right text-sm"
            />
          );
        };

        // --- Dedicated component for Rehab Item Description (Fix for focus loss) ---
        const RehabItemDescriptionInput = ({ id, description, updateHandler }) => {
            const [localValue, setLocalValue] = React.useState(description);
            const [isFocused, setIsFocused] = React.useState(false);

            // Sync local state when parent description changes IF not focused
            React.useEffect(() => {
              if (!isFocused) {
                setLocalValue(description);
              }
            }, [description, isFocused]);

            const handleLocalChange = (e) => {
              setLocalValue(e.target.value);
            };

            const handleBlur = (e) => {
              setIsFocused(false);
              // Update parent state with the description string
              updateHandler(id, 'description', e.target.value);
            };

            return (
                <input
                    type="text"
                    value={localValue}
                    onFocus={() => setIsFocused(true)}
                    onChange={handleLocalChange}
                    onBlur={handleBlur}
                    className="col-span-5 p-1 border rounded-md text-sm"
                />
            );
        };


        // --- Dedicated component for Partner Name (Fix for focus loss) ---
        const PartnerNameInput = ({ id, name, updateHandler }) => {
            const [localValue, setLocalValue] = React.useState(name);
            const [isFocused, setIsFocused] = React.useState(false);

            // Sync local state when parent name changes IF not focused
            React.useEffect(() => {
              if (!isFocused) {
                setLocalValue(name);
              }
            }, [name, isFocused]);

            const handleLocalChange = (e) => {
              setLocalValue(e.target.value);
            };

            const handleBlur = (e) => {
              setIsFocused(false);
              // Update parent state with the name string
              updateHandler(id, 'name', e.target.value);
            };

            return (
                <input
                    type="text"
                    value={localValue}
                    onFocus={() => setIsFocused(true)}
                    onChange={handleLocalChange}
                    onBlur={handleBlur}
                    className="col-span-4 p-1 border rounded-md text-sm"
                />
            );
        };


        // --- Dedicated component for Partner Amount (Fix for focus loss) ---
        const PartnerAmountInput = ({ id, amount, updateHandler }) => {
            const [localValue, setLocalValue] = React.useState(amount);
            const [isFocused, setIsFocused] = React.useState(false);

            // Sync local state when parent amount changes IF not focused
            React.useEffect(() => {
              if (!isFocused) {
                setLocalValue(amount);
              }
            }, [amount, isFocused]);

            const handleLocalChange = (e) => {
              setLocalValue(e.target.value);
            };

            const handleBlur = (e) => {
              setIsFocused(false);
              const finalValue = parseFloat(e.target.value) || 0;
              updateHandler(id, 'amount', finalValue);
              setLocalValue(finalValue);
            };
            
            const displayValue = isFocused ? localValue : (amount === 0 && !isFocused ? '' : amount);


            return (
              <input
                type="text" // Use text input type to allow free typing
                inputMode="numeric"
                min="0"
                value={displayValue}
                onFocus={() => setIsFocused(true)}
                onChange={handleLocalChange}
                onBlur={handleBlur}
                className="col-span-2 p-1 border rounded-md text-right text-sm"
              />
            );
        };


        // --- Main App Component ---
        const Root = () => {
          const [dealData, setDealData] = React.useState(initialDealData);
          const [savedDeals, setSavedDeals] = React.useState([]);
          const [db, setDb] = React.useState(null);
          const [userId, setUserId] = React.useState(null);
          const [isAuthReady, setIsAuthReady] = React.useState(false);
          const [loading, setLoading] = React.useState(false);
          const [message, setMessage] = React.useState('');
          
          // 1. FIREBASE INITIALIZATION AND AUTHENTICATION
          React.useEffect(() => {
            // Check for Firebase existence (loaded by script tags in <head>)
            if (typeof firebase === 'undefined' || !firebaseConfig || !firebaseConfig.apiKey || firebaseConfig.apiKey.includes("PASTE_YOUR")) {
                setUserId('mock-user-id-' + Math.random().toString(36).substring(2, 9));
                setIsAuthReady(true);
                console.warn("Using mock user ID. Firebase functions will be disabled until you paste your real config keys.");
                return;
            }

            try {
              // Initialize app
              let app;
              if (firebase.apps.length === 0) {
                  app = firebase.initializeApp(firebaseConfig);
              } else {
                  app = firebase.app();
              }

              // Get services
              const firestoreDb = firebase.firestore();
              const auth = firebase.auth();
              setDb(firestoreDb);

              const unsubscribe = auth.onAuthStateChanged(async (user) => {
                if (user) {
                  setUserId(user.uid);
                } else {
                  // Attempt anonymous sign-in if no user is found
                  try {
                    if (initialAuthToken) { // This will be undefined, so it will fall to else
                      await auth.signInWithCustomToken(initialAuthToken);
                    } else {
                      const anonUser = await auth.signInAnonymously();
                      setUserId(anonUser.user.uid);
                    }
                  } catch (error) {
                    console.error("Authentication failed:", error);
                    setUserId('auth-failed-' + Math.random().toString(36).substring(2, 9)); 
                  }
                }
                setIsAuthReady(true);
              });

              return () => unsubscribe();
            } catch (e) {
              console.error("Firebase setup error:", e);
            }
          }, []);
          
          // 3. FIRESTORE DATA LISTENER (LOAD DEALS)
          React.useEffect(() => {
            if (!db || !isAuthReady || !userId || userId.startsWith('mock-')) return;

            // This path is simpler and doesn't rely on the 'appId'
            const dealsCollectionRef = db.collection('users').doc(userId).collection('house_flips');

            const unsubscribe = dealsCollectionRef.onSnapshot(
              (querySnapshot) => {
                const deals = [];
                querySnapshot.forEach((doc) => {
                  deals.push({ id: doc.id, ...doc.data() });
                });
                // Sort by timestamp, newest first
                deals.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                setSavedDeals(deals);
              },
              (error) => {
                console.error("Error fetching deals: ", error);
                setMessage("Could not load saved deals.");
              }
            );

            // Clean up the listener on unmount
            return () => unsubscribe();
          }, [db, isAuthReady, userId]);


          // 4. CORE CALCULATION LOGIC
          const calculateDeal = React.useCallback(() => {
            const {
              currentOfferPrice, arv, holdingPeriodMonths, agentCommissionRate, 
              buyerClosingFees, sellerClosingFees, fixedContingency,
              rehabCosts, rehabLumpSum, useLumpSum, partners, targetROI,
              monthlyPITI, monthlyUtilities, monthlyOtherHolding,
            } = dealData;

            // --- Fixed CO Rating Thresholds ---
            const fixedAvgThreshold = 0.10; // 10% Profit Margin (of ARV)
            const fixedGreatThreshold = 0.15; // 15% Profit Margin (of ARV)
            
            // Coerce all inputs to number safely for calculation
            const parsedArv = parseFloat(arv) || 0;
            const parsedAgentCommissionRate = parseFloat(agentCommissionRate) || 0;
            const parsedTargetROI = (parseFloat(targetROI) || 0) / 100;

            // A. Total Rehab Cost (TRC)
            const itemizedRehab = rehabCosts.reduce((sum, item) => sum + (parseFloat(item.cost) || 0), 0);
            const totalRehabCost = useLumpSum ? (parseFloat(rehabLumpSum) || 0) : itemizedRehab;

            // B. Calculated Fixed Costs (Non-Acquisition)
            const sellingCommission = parsedArv * (parsedAgentCommissionRate / 100);
            
            // Calculate Total Monthly Holding Costs
            const totalMonthlyHolding = (parseFloat(monthlyPITI) || 0) + 
                                        (parseFloat(monthlyUtilities) || 0) + 
                                        (parseFloat(monthlyOtherHolding) || 0);

            const totalHoldingCost = (parseFloat(holdingPeriodMonths) || 0) * totalMonthlyHolding;
            
            const sellerClosingFeesParsed = parseFloat(sellerClosingFees) || 0;
            const fixedContingencyParsed = parseFloat(fixedContingency) || 0;
            const buyerClosingFeesParsed = parseFloat(buyerClosingFees) || 0;

            // C. Non-Offer Acquisition Costs (Costs that don't depend on Offer Price)
            const nonOfferAcquisitionCosts = (
                sellingCommission +
                totalHoldingCost +
                sellerClosingFeesParsed +
                fixedContingencyParsed +
                totalRehabCost
            );
            
            // D. Maximum Allowable Offer (MAO) Calculation
            const totalCostsExcludingOffer = buyerClosingFeesParsed + nonOfferAcquisitionCosts;
            
            // MAO (Comprehensive) based on target ROI
            // MAO = (ARV - totalCostsExcludingOffer) / (1 + parsedTargetROI)
            const maoComprehensive = parsedArv > 0 ? (parsedArv - totalCostsExcludingOffer) / (1 + parsedTargetROI) : 0;
            
            // E. 70% Rule MAO Calculation
            // MAO_70% = (ARV * 0.70) - TRC
            const mao70Rule = (parsedArv * 0.70) - totalRehabCost;


            // F. Total Project Cost (Used for Net Profit Calculation)
            // Uses Current Offer Price (replaces old Purchase Price)
            const totalProjectCost = (
              (parseFloat(currentOfferPrice) || 0) +
              buyerClosingFeesParsed +
              nonOfferAcquisitionCosts // Includes all non-offer costs (Rehab, Selling, Holding, etc.)
            );
            
            // G. Minimum Dollar Profit Required (Based on Target ROI)
            const minDollarProfitRequired = totalProjectCost * parsedTargetROI;

            // H. Potential Net Profit (Pre-Split)
            const potentialNetProfit = parsedArv - totalProjectCost;

            // I. Profit Splitting
            let totalPartnerSplit = 0;
            const partnersForSplit = dealData.partners.filter(p => p.type !== 'COMPANY_RETAINER');
            
            const partnerSplits = partnersForSplit.map(partner => {
              // Coerce partner amount safely
              const partnerAmount = parseFloat(partner.amount) || 0;
              
              if (partner.type === 'PERCENT') {
                const splitAmount = potentialNetProfit * (partnerAmount / 100);
                totalPartnerSplit += splitAmount;
                return { ...partner, calculatedAmount: splitAmount };
              }
              if (partner.type === 'FIXED') {
                const splitAmount = partnerAmount;
                totalPartnerSplit += splitAmount;
                return { ...partner, calculatedAmount: splitAmount };
              }
              return partner;
            });

            const companyRetainer = potentialNetProfit - totalPartnerSplit;

            // J. Deal Rating (uses fixed CO market thresholds AND minimum dollar profit required)
            const profitMargin = parsedArv > 0 ? (potentialNetProfit / parsedArv) : 0;
            

            let rating = 'Undefined';
            let ratingColor = 'text-gray-500';

            if (potentialNetProfit < minDollarProfitRequired) {
              rating = 'Bad Deal (Below Target ROI)';
              ratingColor = 'text-red-500';
            } else if (profitMargin < fixedAvgThreshold) {
              rating = 'Bad Deal';
              ratingColor = 'text-red-500';
            } else if (profitMargin >= fixedAvgThreshold && profitMargin < fixedGreatThreshold) {
              rating = 'Average Deal';
              ratingColor = 'text-yellow-500';
            } else {
              rating = 'Great Deal!';
              ratingColor = 'text-green-500';
            }

            // K. Total Fixed Costs (for display in Operating Costs summary)
            // Note: totalFixedCosts in the summary box should include all costs except the Offer Price
            const totalFixedOperatingCosts = (
                buyerClosingFeesParsed +
                sellingCommission +
                totalHoldingCost +
                sellerClosingFeesParsed +
                fixedContingencyParsed
            );


            return {
              arv: parsedArv,
              totalRehabCost,
              sellingCommission,
              totalHoldingCost,
              totalMonthlyHolding, 
              totalFixedOperatingCosts, 
              totalProjectCost,
              potentialNetProfit,
              minDollarProfitRequired, 
              profitMargin,
              partnerSplits,
              totalPartnerSplit,
              companyRetainer,
              rating,
              ratingColor,
              maoComprehensive, 
              mao70Rule, 
              nonOfferAcquisitionCosts,
              fixedAvgThreshold, // Include for display in summary
              fixedGreatThreshold, // Include for display in summary
            };
          }, [dealData]);

          const calculations = React.useMemo(() => calculateDeal(), [calculateDeal]);

          // 5. HANDLERS
          const handleInputChange = (section, field, value) => {
            // Value is processed to a final number by CostInput on blur
            setDealData(prev => ({
              ...prev,
              [field]: value,
            }));
          };

          const updateRehabItem = (id, field, value) => {
            // value is the final number (for 'cost') or string (for 'description'/'category')
            setDealData(prev => ({
              ...prev,
              rehabCosts: prev.rehabCosts.map(item =>
                item.id === id ? { ...item, [field]: value } : item
              ),
            }));
          };

          const addRehabItem = () => {
            setDealData(prev => ({
              ...prev,
              rehabCosts: [
                ...prev.rehabCosts,
                { id: Date.now(), category: 'General Labor & Cleaning', description: '', cost: 0 },
              ],
            }));
          };

          const removeRehabItem = (id) => {
            setDealData(prev => ({
              ...prev,
              rehabCosts: prev.rehabCosts.filter(item => item.id !== id),
            }));
          };

          const addPartner = () => {
            const partnersWithoutRetainer = dealData.partners.filter(p => p.type !== 'COMPANY_RETAINER');
            setDealData(prev => ({
              ...prev,
              partners: [
                ...partnersWithoutRetainer,
                { id: Date.now(), name: `Partner ${partnersWithoutRetainer.length + 1}`, type: 'PERCENT', amount: 50 },
              ],
            }));
          };

          const updatePartner = (id, field, value) => {
            // value is the final number (for 'amount') or string (for 'name'/'type')
            setDealData(prev => ({
              ...prev,
              partners: prev.partners.map(p =>
                p.id === id ? { ...p, [field]: value } : p
              ),
            }));
          };

          const removePartner = (id) => {
            setDealData(prev => ({
              ...prev,
              partners: prev.partners.filter(item => item.id !== id),
            }));
          };

          // Handler for suggesting closing fees (Colorado Estimates)
          const handleSuggestFee = (feeType) => {
            const { currentOfferPrice, arv } = dealData;
            let suggestedValue = 0;
            let field = '';
            let percentage = 0;

            if (feeType === 'buyer') {
                // Suggested Buyer Fees (CO Estimate): 2.0% of Current Offer Price
                percentage = 0.02;
                suggestedValue = Math.round(currentOfferPrice * percentage);
                field = 'buyerClosingFees';
            } else if (feeType === 'seller') {
                // Suggested Seller Fees (CO Estimate): 3.0% of ARV
                percentage = 0.03;
                suggestedValue = Math.round(arv * percentage);
                field = 'sellerClosingFees';
            }

            setDealData(prev => ({
                ...prev,
                [field]: suggestedValue,
            }));
            setMessage(`Suggested ${percentage * 100}% (CO Est.) fee of ${formatCurrency(feeType === 'buyer' ? currentOfferPrice : arv)} applied to ${feeType} fees.`);
            setTimeout(() => setMessage(''), 3000);
          };

          const handleSaveDeal = async () => {
            if (!isAuthReady || !userId || !db || userId.startsWith('mock-')) {
              setMessage("Cannot save: Firebase is not initialized/authenticated.");
              return;
            }
            setLoading(true);
            setMessage('');
            
            // Clean up partners list before saving
            const partnersToSave = dealData.partners.filter(p => p.type !== 'COMPANY_RETAINER');
            
            // All dealData fields, including dealName and calculatedBy, are included via spread operator
            const dataToSave = {
              ...dealData,
              partners: partnersToSave,
              timestamp: new Date().toISOString(),
              summary: {
                netProfit: calculations.potentialNetProfit,
                profitMargin: calculations.profitMargin,
                rating: calculations.rating,
                maoComprehensive: calculations.maoComprehensive, 
                mao70Rule: calculations.mao70Rule, 
                ratingColor: calculations.ratingColor,
              }
            };

            try {
              // Use the new, simpler path
              const dealsCollectionRef = db.collection('users').doc(userId).collection('house_flips');
              await dealsCollectionRef.add(dataToSave);
              
              setMessage(`Deal "${dealData.dealName}" saved successfully!`);
              setTimeout(() => setMessage(''), 3000);
            } catch (e) {
              console.error("Error saving document: ", e);
              setMessage("Error saving deal. Check console for details.");
            } finally {
              setLoading(false);
            }
          };

          const handleLoadDeal = (deal) => {
            setDealData({
                ...initialDealData, // Start with a fresh structure to ensure all keys exist
                ...deal,
            });
            setMessage(`Loaded deal: ${deal.dealName}`);
            setTimeout(() => setMessage(''), 3000);
          };

          const handleClear = () => {
            setDealData(initialDealData);
            setMessage('Calculator cleared. Ready for a new deal!');
            setTimeout(() => setMessage(''), 3000);
          };

          const handleDeleteDeal = async (id) => {
            if (!isAuthReady || !userId || !db || userId.startsWith('mock-')) {
              setMessage("Cannot delete: Firebase is not initialized/authenticated.");
              return;
            }
            setLoading(true);
            try {
              // Use the new, simpler path
              const docRef = db.collection('users').doc(userId).collection('house_flips').doc(id);
              await docRef.delete();
              
              setMessage('Deal deleted successfully.');
              setTimeout(() => setMessage(''), 3000);
            } catch (e) {
              console.error("Error deleting document: ", e);
              setMessage("Error deleting deal. Check console for details.");
            } finally {
              setLoading(false);
            }
          };
          

          // --- UI COMPONENTS ---

          const RevenueMAOSection = () => (
            <div className="space-y-6">
              <h2 className="text-2xl font-bold text-indigo-700">1. Revenue, Targets & Maximum Offer</h2>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                {/* Revenue/Target */}
                <div className="bg-white p-5 rounded-xl shadow-md border border-indigo-100">
                  <h3 className="text-xl font-semibold mb-4 text-indigo-600">Deal Value & Target ROI</h3>
                  <CostInput label="After Repair Value (ARV)" value={dealData.arv} field="arv" unit="$" handler={handleInputChange} />
                  <CostInput label="Target ROI on Total Cost" value={dealData.targetROI} field="targetROI" unit="%" handler={handleInputChange} />
                  
                  <div className="pt-4 border-t mt-4">
                    <CostInput label="Current Offer Price" value={dealData.currentOfferPrice} field="currentOfferPrice" unit="$" handler={handleInputChange} />
                  </div>
                </div>
                
                {/* MAO Display */}
                <div className="p-5 rounded-xl shadow-md border border-orange-500 bg-orange-50 space-y-3">
                    <h3 className="text-xl font-bold text-orange-700">Calculated Max Offer (MAO)</h3>
                    <div className="text-sm text-gray-700">
                        The MAO is the highest price you can pay while meeting your targets.
                    </div>
                    
                    <div className="p-3 bg-white rounded-lg shadow-inner">
                        <div className="text-xs font-semibold text-orange-600">MAO (70% Rule):</div>
                        <div className="text-2xl font-extrabold text-orange-700">
                            {formatCurrency(calculations.mao70Rule)}
                        </div>
                    </div>

                    <div className="p-3 bg-white rounded-lg shadow-inner">
                        <div className="text-xs font-semibold text-indigo-600">MAO (Comprehensive):</div>
                        <div className="text-2xl font-extrabold text-indigo-700">
                            {formatCurrency(calculations.maoComprehensive)}
                        </div>
                    </div>
                    <p className="text-xs text-gray-500 mt-2 p-2 bg-gray-100 rounded-md">
                        <strong>70% Rule:</strong> A quick estimate (ARV * 70%) - TRC. It often serves as a quick check but is less precise.
                        <br/><strong>Comprehensive MAO:</strong> The mathematically precise limit, tailored to your <strong>Target ROI</strong> and all specific closing/holding costs.
                    </p>
                </div>
              </div>
            </div>
          );

          const RehabCostsSection = () => (
            <div className="space-y-6">
              <h2 className="text-2xl font-bold text-indigo-700">2. Rehab & Variable Costs (TRC)</h2>

              {/* Mode Switch */}
              <div className="flex items-center space-x-4 p-4 bg-yellow-50 rounded-xl shadow-md border border-yellow-200">
                <span className="font-semibold text-yellow-800">Input Mode:</span>
                <button
                  onClick={() => handleInputChange(0, 'useLumpSum', false)}
                  className={`px-4 py-2 rounded-full font-semibold transition ${
                    !dealData.useLumpSum ? 'bg-indigo-600 text-white shadow-md' : 'bg-white text-indigo-600 border border-indigo-300'
                  }`}
                >
                  Itemized Costs
                </button>
                <button
                  onClick={() => handleInputChange(0, 'useLumpSum', true)}
                  className={`px-4 py-2 rounded-full font-semibold transition ${
                    dealData.useLumpSum ? 'bg-indigo-600 text-white shadow-md' : 'bg-white text-indigo-600 border border-indigo-300'
                  }`}
                >
                  Lump Sum TRC
                </button>
              </div>

              {/* Lump Sum Input */}
              {dealData.useLumpSum && (
                <div className="bg-white p-5 rounded-xl shadow-md border border-indigo-100">
                  <h3 className="text-xl font-semibold mb-4 text-indigo-600">Lump Sum Total Rehab Cost</h3>
                  <CostInput
                    label="Total Rehab Cost (Lump Sum)"
                    value={dealData.rehabLumpSum}
                    field="rehabLumpSum"
                    unit="$"
                    placeholder={0}
                    handler={handleInputChange}
                  />
                </div>
              )}

              {/* Itemized Input */}
              {!dealData.useLumpSum && (
                <div className="bg-white p-5 rounded-xl shadow-md border border-indigo-100">
                  <h3 className="text-xl font-semibold mb-4 text-indigo-600">Itemized Rehab Breakdown</h3>
                  <div className="grid grid-cols-12 gap-2 font-semibold text-sm text-gray-600 border-b pb-2 mb-2">
                    <div className="col-span-3">Category</div>
                    <div className="col-span-5">Description (e.g., Kitchen Cabinets)</div>
                    <div className="col-span-3 text-right">Cost ($)</div>
                    <div className="col-span-1"></div>
                  </div>
                  {dealData.rehabCosts.map((item) => (
                    <div key={item.id} className="grid grid-cols-12 gap-2 items-center py-2 border-b border-gray-100">
                      <select
                        value={item.category}
                        onChange={(e) => updateRehabItem(item.id, 'category', e.target.value)}
                        className="col-span-3 p-1 border rounded-md text-sm"
                      >
                        <option>Permits & Plans</option>
                        <option>Demolition & Debris</option>
                        <option>Foundation & Structural</option>
                        <option>Roofing</option>
                        <option>Siding & Exterior Trim</option>
                        <option>Windows & Exterior Doors</option>
                        <option>HVAC System</option>
                        <option>Plumbing System</option>
                        <option>Electrical System</option>
                        <option>Insulation & Drywall</option>
                        <option>Interior Paint & Trim</option>
                        <option>Flooring (Hardwood, Carpet, Tile)</option>
                        <option>Kitchen Cabinets & Countertops</option>
                        <option>Kitchen Appliances</option>
                        <option>Bathrooms</option>
                        <option>Lighting & Fixtures</option>
                        <option>Landscaping & Hardscape</option>
                        <option>Decks, Patios & Porches</option>
                        <option>Garage & Driveway</option>
                        <option>Safety & Security</option>
                        <option>Warranties & Punchlist</option>
                        <option>General Labor & Cleaning</option>
                        <option>Other Contingency/Misc</option>
                      </select>
                      {/* Using the dedicated RehabItemDescriptionInput component here */}
                      <RehabItemDescriptionInput 
                        id={item.id}
                        description={item.description}
                        updateHandler={updateRehabItem}
                      />
                      {/* Using the dedicated RehabItemCostInput component here */}
                      <RehabItemCostInput
                        id={item.id}
                        cost={item.cost}
                        updateHandler={updateRehabItem}
                      />
                      <button
                        onClick={() => removeRehabItem(item.id)}
                        className="col-span-1 text-red-500 hover:text-red-700 transition"
                        title="Remove Item"
                      >
                        &times;
                      </button>
                    </div>
                  ))}
                  <button
                    onClick={addRehabItem}
                    className="mt-4 px-4 py-2 text-sm bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 transition"
                  >
                    + Add Rehab Item
                  </button>
                </div>
              )}

              {/* Summary Box */}
              <div className="p-4 bg-green-50 rounded-lg shadow-inner mt-4">
                <div className="flex justify-between items-center font-bold text-xl text-green-800">
                  <span>Total Rehab Cost (TRC):</span>
                  <span>{formatCurrency(calculations.totalRehabCost)}</span>
                </div>
                <p className="text-sm text-green-600 mt-1">This is the variable cost factored into the deal analysis.</p>
              </div>
            </div>
          );
          
          const OperatingCostsSection = () => (
            <div className="space-y-6">
              <h2 className="text-2xl font-bold text-indigo-700">3. Operating & Fixed Costs</h2>
              
              {/* Commissions, Fees, Holding Costs, and Thresholds */}
              <div className="bg-white p-5 rounded-xl shadow-md border border-indigo-100">
                  <h3 className="text-xl font-semibold mb-4 text-indigo-600">Commissions, Fees & Holding Costs</h3>
                  <CostInput label="Selling Agent Commission Rate" value={dealData.agentCommissionRate} field="agentCommissionRate" unit="%" handler={handleInputChange} />
                  <div className="flex justify-between items-center py-2 text-sm text-gray-500 border-b">
                    <div>Calculated Commission ({formatPercent(dealData.agentCommissionRate / 100)} of ARV):</div>
                    <div className="font-medium">{formatCurrency(calculations.sellingCommission)}</div>
                  </div>
                  <CostInput 
                    label="Buyer Closing Fees (Acquisition)" 
                    value={dealData.buyerClosingFees} 
                    field="buyerClosingFees" 
                    unit="$" 
                    handler={handleInputChange} 
                    extraContent={
                      <button 
                        onClick={() => handleSuggestFee('buyer')} 
                        className="text-xs px-2 py-1 bg-indigo-100 text-indigo-600 rounded-full hover:bg-indigo-200 transition"
                        title="Suggest 2.0% of Current Offer Price (CO Estimate)"
                      >
                        Suggest (CO 2.0%)
                      </button>
                    }
                  />
                  <CostInput 
                    label="Seller Closing Fees (Sale)" 
                    value={dealData.sellerClosingFees} 
                    field="sellerClosingFees" 
                    unit="$" 
                    handler={handleInputChange} 
                    extraContent={
                      <button 
                        onClick={() => handleSuggestFee('seller')} 
                        className="text-xs px-2 py-1 bg-indigo-100 text-indigo-600 rounded-full hover:bg-indigo-200 transition"
                        title="Suggest 3.0% of ARV (CO Estimate)"
                      >
                        Suggest (CO 3.0%)
                      </button>
                    }
                  />
                  <CostInput label="Holding Period" value={dealData.holdingPeriodMonths} field="holdingPeriodMonths" unit="mo" handler={handleInputChange} />
                  
                  {/* Itemized Monthly Holding Costs */}
                  <div className="mt-4 pt-4 border-t">
                    <h4 className="text-sm font-semibold text-gray-700 mb-2">Itemized Monthly Holding Costs ({formatCurrency(calculations.totalMonthlyHolding)}/mo):</h4>
                    <CostInput label="&nbsp;&nbsp;&nbsp;PITI (or Debt Service)" value={dealData.monthlyPITI} field="monthlyPITI" unit="$" handler={handleInputChange} />
                    <CostInput label="&nbsp;&nbsp;&nbsp;Utilities & HOA" value={dealData.monthlyUtilities} field="monthlyUtilities" unit="$" handler={handleInputChange} />
                    <CostInput label="&nbsp;&nbsp;&nbsp;Other Monthly Costs" value={dealData.monthlyOtherHolding} field="monthlyOtherHolding" unit="$" handler={handleInputChange} />
                  </div>
                  
                  <div className="flex justify-between items-center py-2 text-sm text-gray-500 border-b">
                    <div>Calculated Total Holding Cost:</div>
                    <div className="font-medium">{formatCurrency(calculations.totalHoldingCost)}</div>
                  </div>

                  <CostInput label="General Fixed Contingency/Other" value={dealData.fixedContingency} field="fixedContingency" unit="$" handler={handleInputChange} />
              </div>

              
              {/* Summary Box */}
              <div className="p-4 bg-indigo-50 rounded-lg shadow-inner mt-4">
                <div className="flex justify-between items-center font-bold text-xl text-indigo-800">
                  <span>Total Fixed Operating Costs (Excluding Offer Price):</span>
                  <span>{formatCurrency(calculations.totalFixedOperatingCosts)}</span>
                </div>
                <p className="text-sm text-indigo-600 mt-1">This sum includes Total Holding Costs, Commissions, and all Fixed Fees.</p>
              </div>
            </div>
          );

          const ProfitSplitSection = () => {
            const totalAllocated = calculations.partnerSplits.reduce((sum, p) => sum + p.calculatedAmount, 0);

            return (
              <div className="space-y-6 pt-10">
                <h2 className="text-2xl font-bold text-indigo-700">4. Profit Splitting</h2>

                <div className="p-4 bg-indigo-50 rounded-lg shadow-inner mb-6">
                  <div className="flex justify-between font-bold text-2xl text-indigo-800">
                    <span>Potential Net Profit (Pre-Split):</span>
                    <span>{formatCurrency(calculations.potentialNetProfit)}</span>
                  </div>
                  <p className="text-sm text-indigo-600 mt-1">This is the amount of profit available to be split among partners and the company.</p>
                </div>

                <div className="bg-white p-5 rounded-xl shadow-md border border-indigo-100">
                  <h3 className="text-xl font-semibold mb-4 text-indigo-600">Partner Allocations</h3>

                  <div className="grid grid-cols-12 gap-2 font-semibold text-sm text-gray-600 border-b pb-2 mb-2">
                    <div className="col-span-4">Partner Name</div>
                    <div className="col-span-3">Split Type</div>
                    <div className="col-span-2">Amount</div>
                    <div className="col-span-2 text-right">Allocation</div>
                    <div className="col-span-1"></div>
                  </div>

                  {calculations.partnerSplits.map((partner) => (
                    <div key={partner.id} className="grid grid-cols-12 gap-2 items-center py-2 border-b border-gray-100">
                      {/* Using the dedicated PartnerNameInput component here */}
                      <PartnerNameInput 
                        id={partner.id}
                        name={partner.name}
                        updateHandler={updatePartner}
                      />
                      <select
                        value={partner.type}
                        onChange={(e) => updatePartner(partner.id, 'type', e.target.value)}
                        className="col-span-3 p-1 border rounded-md text-sm"
                      >
                        <option value="PERCENT">% of Net Profit</option>
                        <option value="FIXED">Fixed Amount ($)</option>
                      </select>
                      {/* Using the dedicated PartnerAmountInput component here */}
                      <PartnerAmountInput 
                        id={partner.id}
                        amount={partner.amount}
                        updateHandler={updatePartner}
                      />
                      <div className="col-span-2 text-right font-medium text-sm text-indigo-700">
                        {formatCurrency(partner.calculatedAmount)}
                      </div>
                      <button
                        onClick={() => removePartner(partner.id)}
                        className="col-span-1 text-red-500 hover:text-red-700 transition"
                        title="Remove Partner"
                      >
                        &times;
                      </button>
                    </div>
                  ))}

                  <button
                    onClick={addPartner}
                    className="mt-4 px-4 py-2 text-sm bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 transition"
                  >
                    + Add Partner
                  </button>
                </div>

                {/* Final Split Summary */}
                <div className="space-y-3 pt-4">
                  <div className="flex justify-between font-bold text-lg text-gray-700 border-b pb-2">
                    <span>Total Allocated to Partners:</span>
                    <span>{formatCurrency(totalAllocated)}</span>
                  </div>
                  <div className="flex justify-between font-extrabold text-2xl text-green-700">
                    <span>Company Retained Profit:</span>
                    <span>{formatCurrency(calculations.companyRetainer)}</span>
                  </div>
                  <p className="text-sm text-gray-500">This is the profit rolled back into the business after all partner distributions.</p>
                </div>
              </div>
            );
          };
          
          const FinalSummarySection = ({ arv }) => { // ARV passed as prop
            const {
              potentialNetProfit, profitMargin, rating, ratingColor, totalProjectCost,
              totalFixedOperatingCosts, totalRehabCost, totalPartnerSplit, companyRetainer,
              maoComprehensive, mao70Rule, minDollarProfitRequired,
              fixedAvgThreshold, fixedGreatThreshold // Used fixed thresholds for display
            } = calculations;

            // Determine the rating border class explicitly
            let ratingBorderClass;
            if (ratingColor === 'text-red-500') {
                ratingBorderClass = 'border-red-500';
            } else if (ratingColor === 'text-yellow-500') {
                ratingBorderClass = 'border-yellow-500';
            } else if (ratingColor === 'text-green-500') {
                ratingBorderClass = 'border-green-500';
            } else {
                ratingBorderClass = 'border-gray-500';
            }
            
            // --- Deal Action Plan Logic ---
            const generateActionPlan = () => {
                let plan = [];
                const currentOfferPrice = parseFloat(dealData.currentOfferPrice) || 0;
                const targetROI = parseFloat(dealData.targetROI) / 100 || 0;

                // 1. Check ROI Deficit
                const profitToHitROI = minDollarProfitRequired - potentialNetProfit;

                // If the deal is below the minimum required ROI, the primary goal is hitting the target profit.
                if (profitToHitROI > 0) {
                    plan.push({
                        goal: `Achieve Minimum ${dealData.targetROI}% Target ROI:`,
                        deficit: profitToHitROI,
                        targetRating: 'Minimum ROI'
                    });
                }
                
                // 2. Check Average Deal Deficit (10% Margin)
                const profitToHitAverage = (arv * fixedAvgThreshold) - potentialNetProfit;

                if (rating.includes('Bad Deal')) {
                    plan.push({
                        goal: `Reach Average Deal (${formatPercent(fixedAvgThreshold)} ARV Margin):`,
                        deficit: profitToHitAverage,
                        targetRating: 'Average Deal'
                    });
                }

                // 3. Check Great Deal Deficit (15% Margin)
                const profitToHitGreat = (arv * fixedGreatThreshold) - potentialNetProfit;
                
                if (rating.includes('Bad Deal') || rating === 'Average Deal') {
                    plan.push({
                        goal: `Reach Great Deal (${formatPercent(fixedGreatThreshold)} ARV Margin):`,
                        deficit: profitToHitGreat,
                        targetRating: 'Great Deal'
                    });
                }

                // Filter for valid (positive) deficits
                const validGoals = plan.filter((p) => p.deficit > 0);
                
                // Remove duplicates based on targetRating
                const uniqueGoals = validGoals.filter((p, index, self) => 
                    index === self.findIndex((t) => (t.targetRating === p.targetRating))
                );

                return uniqueGoals;
            };

            const actionPlan = generateActionPlan();

            return (
              <div className="space-y-6 pt-10">
                <h2 className="text-2xl font-bold text-indigo-700">5. Deal Summary & Analysis</h2>

                {/* MAO Card */}
                <div className="bg-orange-600 text-white p-6 rounded-xl shadow-2xl border-4 border-orange-400">
                  <div className="text-lg font-semibold mb-2">Maximum Allowable Offer (MAO) Targets:</div>
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <div className="text-xl font-extrabold">{formatCurrency(mao70Rule)}</div>
                      <div className="text-sm font-light text-orange-200">70% Rule Target</div>
                    </div>
                    <div>
                      <div className="text-xl font-extrabold">{formatCurrency(maoComprehensive)}</div>
                      <div className="text-sm font-light text-orange-200">Comprehensive Target</div>
                    </div>
                  </div>
                </div>


                {/* Final Profit Card */}
                <div className="bg-indigo-700 text-white p-6 rounded-xl shadow-2xl border-4 border-indigo-400">
                  <div className="text-lg font-semibold mb-2">Potential Net Profit (Based on Current Offer Price):</div>
                  <div className="text-5xl font-extrabold mb-4">{formatCurrency(potentialNetProfit)}</div>
                  <div className="text-lg font-semibold">Profit Margin (of ARV): <span className="font-extrabold">{formatPercent(profitMargin)}</span></div>
                </div>

                {/* Deal Rating */}
                <div className={`p-4 rounded-lg shadow-md border-2 ${ratingBorderClass}`} >
                  <h3 className="text-xl font-bold text-gray-800">Deal Rating:</h3>
                  <div className={`text-3xl font-extrabold ${ratingColor}`}>{rating}</div>
                  <p className="text-sm text-gray-600 mt-2">
                    *Rating based on standard Colorado house flipping market margins:<br/>
                    - <strong>Bad Deal:</strong> Below {formatPercent(fixedAvgThreshold)} or below required ROI of {formatCurrency(minDollarProfitRequired)}.<br/>
                    - <strong>Average Deal:</strong> Between {formatPercent(fixedAvgThreshold)} and {formatPercent(fixedGreatThreshold)}.<br/>
                    - <strong>Great Deal!:</strong> At or Above {formatPercent(fixedGreatThreshold)}.
                  </p>
                </div>

                {/* Deal Action Plan */}
                {actionPlan.length > 0 && (
                    <div className="bg-blue-50 p-5 rounded-xl shadow-md border border-blue-300 space-y-4">
                        <h3 className="text-xl font-bold text-blue-700">Deal Action Plan</h3>
                        {actionPlan.map((plan, index) => (
                            <div key={index} className="space-y-2 border-b pb-3 last:border-b-0">
                                <p className="font-semibold text-gray-800">{plan.goal}</p>
                                <div className="text-sm space-y-1">
                                    {/* Levers to pull */}
                                    <p className="flex justify-between">
                                        <span className="text-gray-600 font-medium">1. Offer Price Adjustment:</span>
                                        <span className="text-green-700 font-bold">
                                            Reduce the offer price by {formatCurrency(plan.deficit)}
                                        </span>
                                    </p>
                                    <p className="flex justify-between">
                                        <span className="text-gray-600 font-medium">2. Rehab/Cost Reduction:</span>
                                        <span className="text-green-700 font-bold">
                                            Cut Total Rehab/Operating Costs by {formatCurrency(plan.deficit)}
                                        </span>
                                    </p>
                                    <p className="flex justify-between">
                                        <span className="text-gray-600 font-medium">3. ARV Increase:</span>
                                        <span className="text-green-700 font-bold">
                                            Increase ARV by {formatCurrency(plan.deficit)}
                                        </span>
                                    </p>
                                    <p className="text-xs text-blue-500 pt-1">
                                        *Note: You can combine these actions (e.g., $10k cost cut + $15k offer reduction = $25k gain).
                                    </p>
                                </div>
                            </div>
                        ))}
                    </div>
                )}
                
                {/* Cost Breakdown */}
                <div className="bg-white p-5 rounded-xl shadow-md border border-gray-100">
                  <h3 className="text-xl font-semibold mb-4 text-gray-700">Detailed Cost Summary</h3>
                  <div className="space-y-2">
                    <div className="flex justify-between text-base">
                      <span className="text-gray-600">After Repair Value (ARV)</span>
                      <span className="font-medium text-indigo-600">{formatCurrency(calculations.arv)}</span>
                    </div>
                    <div className="flex justify-between text-base">
                      <span className="text-gray-600">Total Rehab Cost (TRC)</span>
                      <span className="font-medium text-red-500">({formatCurrency(totalRehabCost)})</span>
                    </div>
                    <div className="flex justify-between text-base">
                      <span className="text-gray-600">Total Fixed Operating Costs (Holding, Selling, Fees, Contingency)</span>
                      <span className="font-medium text-red-500">({formatCurrency(totalFixedOperatingCosts)})</span>
                    </div>
                    <div className="flex justify-between text-base">
                      <span className="text-gray-600">Current Offer Price</span>
                      <span className="font-medium text-red-500">({formatCurrency(dealData.currentOfferPrice)})</span>
                    </div>
                    <div className="flex justify-between font-bold text-lg border-t pt-2 mt-2">
                      <span>TOTAL PROJECT COST</span>
                      <span className="text-red-700">({formatCurrency(totalProjectCost)})</span>
                    </div>
                    <div className="flex justify-between font-bold text-lg">
                        <span>MINIMUM DOLLAR PROFIT REQUIRED ({dealData.targetROI}%)</span>
                        <span className="text-red-700">({formatCurrency(minDollarProfitRequired)})</span>
                    </div>
                  </div>
                </div>

                {/* Partner Split Review */}
                <div className="bg-white p-5 rounded-xl shadow-md border border-gray-100">
                  <h3 className="text-xl font-semibold mb-4 text-gray-700">Profit Distribution</h3>
                  <div className="space-y-2">
                    <div className="flex justify-between text-base">
                      <span className="text-gray-600">Total Allocated to Partners</span>
                      <span className="font-medium text-indigo-700">{formatCurrency(totalPartnerSplit)}</span>
                    </div>
                    <div className="flex justify-between font-bold text-lg border-t pt-2 mt-2">
                      <span>COMPANY RETAINED PROFIT (Rolled back into business)</span>
                      <span className="text-green-700">{formatCurrency(companyRetainer)}</span>
                    </div>
                  </div>
                </div>

                {/* Action Buttons */}
                <div className="flex flex-col space-y-4 pt-4">
                  <div className="text-center text-sm text-gray-500 h-6">{message}</div>
                  <div className="flex justify-center space-x-4">
                    {/* Note: The Firebase save functions are mocked when deployed outside Canvas */}
                    <button
                      onClick={handleSaveDeal}
                      disabled={loading || !isAuthReady}
                      className="px-6 py-3 bg-green-500 text-white font-bold rounded-lg shadow-lg hover:bg-green-600 transition disabled:opacity-50"
                    >
                      {loading ? 'Saving...' : 'Save Current Calculation'}
                    </button>
                    <button
                      onClick={handleClear}
                      className="px-6 py-3 bg-red-500 text-white font-bold rounded-lg shadow-lg hover:bg-red-600 transition"
                    >
                      Clear Calculator / Restart
                    </button>
                  </div>
                </div>

                {/* Saved Deals List */}
                <div className="pt-8">
                  <h3 className="text-2xl font-bold text-indigo-700 mb-4">Saved Deals ({savedDeals.length})</h3>
                  <div className="space-y-2">
                    {isAuthReady && savedDeals.length === 0 && (
                      <p className="text-gray-500">No saved deals found. Save your first deal above!</p>
                    )}
                    {savedDeals.map((deal) => (
                      <div key={deal.id} className="flex justify-between items-center p-3 bg-white rounded-lg shadow-sm border border-gray-200 hover:bg-indigo-50 transition">
                        <div className="flex-1 min-w-0">
                          <div className="font-semibold truncate">{deal.dealName}</div>
                          <div className="text-xs text-gray-500">
                            Profit: {formatCurrency(deal.summary.netProfit)} | Margin: {formatPercent(deal.summary.profitMargin)}
                          </div>
                        </div>
                        <div className="flex space-x-2 ml-4">
                          <span className={`text-sm font-bold ${deal.summary.ratingColor}`}>{deal.summary.rating.split('(')[0].trim()}</span>
                          <button onClick={() => handleLoadDeal(deal)} className="text-indigo-600 hover:text-indigo-800 transition text-sm font-semibold">
                            Load
                          </button>
                          <button onClick={() => handleDeleteDeal(deal.id)} className="text-red-500 hover:text-red-700 transition text-sm">
                            Delete
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            );
          };

          return (
            <div className="min-h-screen bg-gray-50 p-4 sm:p-8">
              <h1 className="text-4xl font-extrabold text-indigo-800 mb-6 text-center">
                House Flip Deal Analyzer 
              </h1>

              {/* Global Summary Panel - Always Visible */}
              <div className="sticky top-0 z-10 bg-white p-4 rounded-xl shadow-lg mb-8 border-t-4 border-indigo-500">
                <h2 className="text-xl font-bold text-indigo-700 mb-2">Deal Snapshot:</h2>
                
                {/* Deal Metadata */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <MetadataInput 
                        label="Deal Name" 
                        value={dealData.dealName} 
                        field="dealName" 
                        handler={handleInputChange} 
                    />
                    <MetadataInput 
                        label="Calculated By" 
                        value={dealData.calculatedBy} 
                        field="calculatedBy" 
                        handler={handleInputChange} 
                    />
                </div>

                {/* Key Metrics */}
                <div className="grid grid-cols-2 sm:grid-cols-5 gap-4 text-center">
                  <div className="p-2 bg-gray-50 rounded-md">
                    <div className="text-xs text-gray-500">ARV</div>
                    <div className="text-base font-semibold">{formatCurrency(calculations.arv)}</div>
                  </div>
                  <div className="p-2 bg-gray-50 rounded-md bg-orange-100 border border-orange-300">
                    <div className="text-xs text-orange-700 font-bold">MAO (70% Rule)</div>
                    <div className="text-base font-semibold text-orange-700">{formatCurrency(calculations.mao70Rule)}</div>
                  </div>
                  <div className="p-2 bg-gray-50 rounded-md bg-orange-100 border border-orange-300">
                    <div className="text-xs text-orange-700 font-bold">MAO (Comprehensive)</div>
                    <div className="text-base font-semibold text-orange-700">{formatCurrency(calculations.maoComprehensive)}</div>
                  </div>
                  <div className="p-2 bg-gray-50 rounded-md">
                    <div className="text-xs text-gray-500">Net Profit (Current Offer)</div>
                    <div className="text-base font-semibold text-green-600">{formatCurrency(calculations.potentialNetProfit)}</div>
                  </div>
                  <div className="p-2 bg-gray-50 rounded-md">
                    <div className="text-xs text-gray-500">Profit Margin</div>
                    <div className="text-base font-semibold text-green-600">{formatPercent(calculations.profitMargin)}</div>
                  </div>
                </div>
                {/* User ID for Firestore context */}
                <div className="text-xs text-gray-400 mt-2 truncate">User ID: {userId || 'Authenticating...'}</div>
              </div>

              {/* Calculator Sections */}
              <div className="max-w-4xl mx-auto space-y-12">
                <RevenueMAOSection />
                <RehabCostsSection />
                <OperatingCostsSection />
                <ProfitSplitSection />
                <FinalSummarySection arv={dealData.arv} />
              </div>

            </div>
          );
        };
        
        // ** FIX for Blank Screen **
        // Reverting to the older, more stable ReactDOM.render method.
        // This will fix the "blank screen" compilation error on GitHub Pages.
        // It WILL show a harmless warning in the console, which is safe to ignore.
        const container = document.getElementById('root');
        if (container) {
          ReactDOM.render(<Root />, container);
        } else {
          console.error("Root element not found. The app could not be started.");
        }
    </script>
</body>
</html>